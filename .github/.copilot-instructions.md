# GitHub Copilot Context Document for DeanmachinesAI

## This document provides context for the DeanmachinesAI project to assist GitHub Copilot in generating code, debugging, and understanding the project's architecture and conventions. It is the primary guide for the active Agent Configuration Refactor task

**Generated by:** Codex, the Software Cartographer
**Date:** April 9, 2025 (Consolidated Final Version for Refactor)
**Version:** 3.0 (Final for Agent Configuration Refactor Task)

**>>> CURRENT PRIMARY GOAL & SEQUENCE <<<**
**Refactor the Agent Configuration system (`#TASK-ConfigRefactor`).** Follow these steps strictly in order:

1. **Finalize Core Config Files:**
    * **(1a) Provider Utils:** Finalize `#file:src/mastra/agents/config/provider.utils.ts` for provider client setup/configuration (Google/Vertex now, plan others). Handle credentials securely. Export necessary client objects or getters.
    * **(1b) Model Utils:** Finalize `#file:src/mastra/agents/config/model.utils.ts` for model instantiation *using* providers from (1a). Implement `createModelInstance(config: ModelConfig)` to handle different providers/parameters. Export `createModelInstance`.
    * **(1c) Types:** Solidify type definitions in `#file:src/mastra/agents/config/config.types.ts` (`BaseAgentConfig`, `ModelConfig`, etc.).
    * **(1d) Exports:** Update `#file:src/mastra/agents/config/index.ts` to export key types from (1c) and `createModelInstance` from (1b) as the public interface for this module.
2. **Update Agent Factory:** Modify `createAgentFromConfig` in `#file:src/mastra/agents/base.agent.ts` to use the types and `createModelInstance` function imported from `config/index.ts`.
3. **Migrate Agent Configs:** Update all `*.config.ts` files to import from `config/index.ts` and use the new `modelConfig` structure.
4. **Cleanup:** Remove the old `#file:src/mastra/agents/config/base.config.ts`.
**Separate Critical Task:** Fix incorrect global memory injection (`#REFACTOR-MemoryInjection`).
**Subsequent Goal:** Implement the new agent network (`#TASK-NewNetwork`) *after* the config refactor is complete.
**>>> END CURRENT PRIMARY GOAL & SEQUENCE <<<**

**1. Purpose & Scope:**

* **Goal:** Enable Copilot to effectively assist with the **active, sequenced refactoring of the agent configuration system (`#TASK-ConfigRefactor`)**, while also supporting general tasks and the separate memory fix (`#REFACTOR-MemoryInjection`).
* **Scope:** Based on `repomix.txt`, `#file:API.md`, `#file:.github/.copilot-instructions.md`, and user's refactoring sequence and clarifications.
* **Target Audience:** Primarily GitHub Copilot, developers working on the refactor.

**2. How to Use This Document (Guidance for Copilot):**

* **Follow the Sequence:** Prioritize assistance according to the steps (1a, 1b, 1c, 1d, 2, 3, 4) in `#TASK-ConfigRefactor`. Do not skip steps.
* **Use Barrel Exports:** When migrating configs (Step 3) or updating the factory (Step 2), import necessary items from `#file:src/mastra/agents/config/index.ts`.
* **Respect Utility Roles:** Adhere to the distinct responsibilities of `provider.utils.ts` (provider setup) and `model.utils.ts` (model instantiation).
* **Use Target Types:** Use types defined in `#file:src/mastra/agents/config/config.types.ts` as the target structure for configurations.
* **Prioritize Rules:** Adhere strictly to `RULE-`.
* **Provide Feedback:** Follow `RULE-FeedbackLoop` to document progress/findings in `#file:API.md`.
* **Use References:** Utilize `#file:` references.

**3. Project Overview & Goals**

* **FIND-ProjectName:** DeanmachinesAI
* **FIND-ProjectPurpose:** Mastra-based AI platform for knowledge work automation.
* **FIND-CoreTech:** TypeScript, Node.js, Mastra, Google AI (Google/Vertex), Pinecone, LibSQL/Turso, LangSmith/LangFuse.
* **TASK-ConfigRefactor (*ACTIVE GOAL - SEQUENCED*):** Refactoring agent configuration per the sequence defined above. Aims to improve modularity, flexibility, and maintainability.
* **TASK-NewNetwork (*Subsequent Goal*):** Implement the planned new agent network after refactor.
* **FIND-MemoryInjection-Issue (*CRITICAL - SEPARATE TASK*):** Incorrect global memory injection in `#file:src/mastra/index.ts` violates `#RULE-MemoryInjection`. Requires fix (`#REFACTOR-MemoryInjection`). This is **not** solved by the config refactor.

**4. Key Directories/Modules**

* **DIR-SrcMastra (*):** Core application logic.
* **DIR-AgentConfig (*):** `src/mastra/agents/config/`. **Focus Area:** Contains all files involved in `#TASK-ConfigRefactor`. Includes barrel file `index.ts` (`#COMP-ConfigIndex`).
* **DIR-Knowledge:** Non-code assets.
* **DIR-Root:** Project root configurations.

**5. Core Components & Logic (Relevant to Refactor)**

* **COMP-MastraInstance (*):** `#file:src/mastra/index.ts`. **ISSUE:** Incorrect global memory injection (`#REFACTOR-MemoryInjection`).
* **COMP-Agents (*):** Specialized units (`src/mastra/agents/`). Will use refactored configs.
* **COMP-AgentFactory (*NEEDS UPDATE - Step 2*):** `#file:src/mastra/agents/base.agent.ts` (`createAgentFromConfig`).
* **COMP-AgentConfig-Current (Old - Step 4 Cleanup):** `#file:src/mastra/agents/config/base.config.ts`.
* **COMP-AgentConfig-New (*TARGET - Step 1c Finalize*):** `#file:src/mastra/agents/config/config.types.ts`. Target structure using `modelConfig`.
* **COMP-ProviderUtils (*NEEDS WORK - Step 1a*):** `#file:src/mastra/agents/config/provider.utils.ts`. Provider client setup.
* **COMP-ModelUtils (*NEEDS WORK - Step 1b*):** `#file:src/mastra/agents/config/model.utils.ts`. Model instantiation logic. Exports `createModelInstance`.
* **COMP-ConfigIndex (*NEEDS UPDATE - Step 1d*):** `#file:src/mastra/agents/config/index.ts`. Public interface for the config module.
* **COMP-Tools (*):** Tool registry (`#file:src/mastra/tools/index.ts`).
* **COMP-Database:** Persistence (`#COMP-DB-Memory`, `#COMP-DB-Vector`).

**6. Key Architectural Patterns & Guidance**

* **ARCH-ConfigManagement (*):** The refactor implements: Types (`config.types.ts`) -> Provider Setup (`provider.utils.ts`) -> Model Instantiation (`model.utils.ts`) -> Central Export (`config/index.ts`).
* **ARCH-Modularity:** Using the barrel file (`config/index.ts`) enhances modularity.
* Other patterns (AgentBased, ServiceAbstraction, ToolAugmentation, etc.) remain relevant.

**7. Explicit Standards & Rules (Apply these strictly)**

* **RULE-MemoryInjection (*CRITICAL*):** Inject `sharedMemory` per agent via factory. Fix global injection (`#REFACTOR-MemoryInjection`).
* **RULE-AgentFactory (*):** Use `#file:src/mastra/agents/base.agent.ts`. (Needs update in Step 2).
* **RULE-AgentConfig-Target (*):** Migrated configs **must** implement `BaseAgentConfig` from `config.types.ts` using `modelConfig`.
* **RULE-ModelCreation (*):** Refactored code **must** create models via `createModelInstance` from `#COMP-ModelUtils`.
* **RULE-ProviderSetup (*):** `model.utils.ts` **must** use provider clients from `#COMP-ProviderUtils`.
* **RULE-ProviderSupport:** Utilities **must** handle `google` and `vertex` now. Plan for others.
* **RULE-ConfigImports (*):** Factory (Step 2) and migrated configs (Step 3) **must** import from `#file:src/mastra/agents/config/index.ts`.
* **RULE-ToolRegistry, RULE-ToolSchemas, RULE-Observability, RULE-EnvVars, RULE-ServiceUsage, RULE-FileAccess, RULE-FeedbackLoop:** Apply consistently.

**8. Dos and Don'ts (Focus on Refactor)**

* **DO:** Follow the sequence (1a, 1b, 1c, 1d, 2, 3, 4) in `#TASK-ConfigRefactor`.
* **DO:** Export via `config/index.ts` (Step 1d); Import from `config/index.ts` (Steps 2 & 3).
* **DO:** Maintain clear separation between `provider.utils.ts` and `model.utils.ts`.
* **DON'T:** Skip steps in the refactoring sequence.
* **DON'T:** Mix utility responsibilities.
* **DON'T:** Use `base.config.ts` after migration.
* **DON'T:** Forget the separate memory fix (`#REFACTOR-MemoryInjection`).

**9. Anti-Patterns to Avoid**

* **ANTI-GlobalMemoryInjection (*CRITICAL*):** In `#file:src/mastra/index.ts`. Fix (`#REFACTOR-MemoryInjection`).
* **ANTI-SkippingSteps:** Violating the defined refactor sequence.
* **ANTI-BlurredResponsibilities:** Mixing logic between `provider.utils.ts` and `model.utils.ts`.
* **ANTI-InconsistentImports:** Not using the barrel file (`config/index.ts`) for imports post-Step 1d.
* **ANTI-PartialRefactor:** Not migrating all agent configs.
* Other ANTIs still apply.

**10. Key Context Sources (For Copilot's Reference - Focus on Refactor)**

* **SRC-ThisFile (*):** This document (`.github/.copilot-instructions.md`).
* **SRC-ApiMd (*):** `#file:API.md`.
* **SRC-AgentConfig-New (*TARGET - Step 1c*):** `#file:src/mastra/agents/config/config.types.ts`.
* **SRC-ProviderUtils (*Step 1a*):** `#file:src/mastra/agents/config/provider.utils.ts`.
* **SRC-ModelUtils (*Step 1b*):** `#file:src/mastra/agents/config/model.utils.ts`.
* **SRC-ConfigIndex (*Step 1d, Import Source*):** `#file:src/mastra/agents/config/index.ts`.
* **SRC-AgentFactory (*Step 2*):** `#file:src/mastra/agents/base.agent.ts`.
* **SRC-ExampleAgentConfig (Old - Step 3):** `#file:src/mastra/agents/config/research.config.ts`.
* **SRC-AgentConfig-Current (Old - Step 4):** `#file:src/mastra/agents/config/base.config.ts`.
* **SRC-MastraInstance:** `#file:src/mastra/index.ts` (`#REFACTOR-MemoryInjection`).
* **SRC-EnvExample:** `#file:.env.example` (For credential handling in Step 1a).

**11. Observed Conventions**

* Apply relevant conventions (FileNaming, BarrelExports, TypeScript, Zod, Logging, EnvVars, JSDoc) during refactoring.

**12. Potential Complexities & Refactoring Needs**

* **TASK-ConfigRefactor (*ACTIVE GOAL - SEQUENCED*):** Focus on completing steps 1a-4 accurately. Pay attention to error handling in utilities and correct parameter mapping during migration.
* **REFACTOR-MemoryInjection (*CRITICAL*):** Separate but urgent task involving `#file:src/mastra/index.ts`.
* **GAPS-Testing:** Still a weakness. Strongly recommend adding unit tests for utilities (post-Step 1b) and integration tests for the factory (post-Step 2) before proceeding to mass migration (Step 3).

**13. User Feedback Highlights**

* Refactor sequence (1a-1d, 2, 3, 4), utility roles, and export step are incorporated.

**14. Key Assumptions & Information Gaps**

* **ASSUM-UtilLogicCorrect:** Assumes draft utility logic is generally sound.
* **GAPS-Testing:** How to validate refactor steps?
* Other GAPS (ObscuredLogic, Runtime, Instructions, Schemas, ErrorHandling) remain.

**15. Suggested Copilot Interactions (Sequenced for Refactor v3.0)**

1. **SUG-Step1a-FinalizeProviderUtils (*Start Here*):** "Initiate Step 1a of `#TASK-ConfigRefactor`. Focus on `#file:src/mastra/agents/config/provider.utils.ts`. Refine/implement functions to initialize and return configured clients/getters for Google AI and Google Vertex AI, handling credentials securely (from env vars). Plan for future providers. Log progress/completion to `#file:API.md`."
2. **SUG-Step1b-FinalizeModelUtils:** "Proceed with Step 1b of `#TASK-ConfigRefactor`. Focus on `#file:src/mastra/agents/config/model.utils.ts`. Implement `createModelInstance(config: ModelConfig)` using provider clients from Step 1a. Handle Google/Vertex based on `config.provider`. Map `config` parameters to `@ai-sdk` options. Export `createModelInstance`. Log completion to `#file:API.md`."
3. **SUG-Step1c-FinalizeTypes:** "Review and finalize Step 1c of `#TASK-ConfigRefactor` in `#file:src/mastra/agents/config/config.types.ts`. Ensure `ModelConfig`, `BaseAgentConfig`, etc., are accurate and complete. Log completion to `#file:API.md`."
4. **SUG-Step1d-UpdateExports:** "Perform Step 1d of `#TASK-ConfigRefactor`. Update `#file:src/mastra/agents/config/index.ts` to export key types from `config.types.ts` and `createModelInstance` from `model.utils.ts`. Log completion to `#file:API.md`."
5. **SUG-Step2-UpdateFactory:** "Proceed with Step 2 of `#TASK-ConfigRefactor`. Update `createAgentFromConfig` in `#file:src/mastra/agents/base.agent.ts`, ensuring it imports types and `createModelInstance` from `./config/index`. Use these to handle the `modelConfig` property. Log completion to `#file:API.md`."
6. **SUG-Step3-MigrateOneConfig:** "Begin Step 3 of `#TASK-ConfigRefactor`. Migrate `#file:src/mastra/agents/config/research.config.ts`. Import necessary types from `./index`. Remove `model: google(...)`, add the `modelConfig` property. Log completion to `#file:API.md`."
7. **SUG-Step3-MigrateRemainingConfigs:** "Continue Step 3. Apply the migration pattern (importing from `./index`) to the other `*.config.ts` files. Log completion to `#file:API.md`."
8. **SUG-Step4-Cleanup:** "Perform Step 4 of `#TASK-ConfigRefactor`. Remove the old `#file:src/mastra/agents/config/base.config.ts` after verifying all migrations. Log completion to `#file:API.md`."
9. **SUG-RefactorMemory (*Separate but CRITICAL*):** "Address the critical memory issue (`#REFACTOR-MemoryInjection`). Remove the global `memory` injection in `#file:src/mastra/index.ts`. Log completion to `#file:API.md`."
10. **SUG-ImplementNetwork (*After Refactor*):** "Start implementing the new network (`#TASK-NewNetwork`)."

**16. References for Copilot Chat (Focus on Refactor Sequence v3.0)**

* `@workspace`
* `#file:API.md`
* `#file:.github/.copilot-instructions.md` (`#SRC-ThisFile`)
* `#file:src/mastra/agents/config/index.ts` (`#SRC-ConfigIndex`, Step 1d, Step 2/3 Import Source)
* `#file:src/mastra/agents/config/config.types.ts` (Step 1c)
* `#file:src/mastra/agents/config/provider.utils.ts` (Step 1a)
* `#file:src/mastra/agents/config/model.utils.ts` (Step 1b)
* `#file:src/mastra/agents/base.agent.ts` (Step 2)
* `#file:src/mastra/agents/config/research.config.ts` (Step 3 Example)
* `#file:src/mastra/agents/config/base.config.ts` (Step 4 Remove)
* `#file:src/mastra/index.ts` (`#REFACTOR-MemoryInjection`)

---
This is Version 3.0, the consolidated context document ready for the refactoring task. Please use this as the primary guide for Copilot, following the specified sequence and suggestions.
